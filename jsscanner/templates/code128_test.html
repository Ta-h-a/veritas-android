<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code-128 QR Data Scanner Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        #scanner {
            width: 100%;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
            position: relative;
            background: #000;
        }
        
        #scanner canvas,
        #scanner video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-primary { background: #28a745; }
        .btn-warning { background: #ffc107; color: #000; }
        
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #e9ecef;
        }
        
        #results {
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .barcode-result {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }
        
        .barcode-result.code-128 {
            border-left-color: #007bff;
            background: linear-gradient(90deg, #e7f3ff, #ffffff);
        }
        
        .barcode-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            word-break: break-all;
            margin-bottom: 8px;
        }
        
        .barcode-meta {
            font-size: 12px;
            color: #666;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .validation-tags {
            margin-top: 8px;
        }
        
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin: 2px;
        }
        
        .tag.samsung { background: #1f2937; color: white; }
        .tag.india { background: #f59e0b; color: white; }
        .tag.url { background: #10b981; color: white; }
        .tag.json { background: #8b5cf6; color: white; }
        .tag.supply { background: #6b7280; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Code-128 QR Data Scanner</h1>
        
        <div class="info-box">
            <h3>üéØ Enhanced for Code-128 Accuracy</h3>
            <p><strong>Optimized for:</strong> QR-like data encoded in Code-128 barcodes</p>
            <p><strong>Detects:</strong> URLs, JSON data, Samsung codes, India certifications, supply chain data</p>
            <p><strong>Filters:</strong> Short codes, noise, invalid characters</p>
        </div>
        
        <div id="status">Click "Start Scanner" to begin</div>
        
        <div id="scanner"></div>
        
        <button id="startBtn" class="btn-primary" onclick="startScanner()">üöÄ Start Scanner</button>
        <button id="stopBtn" onclick="stopScanner()" disabled>‚èπÔ∏è Stop Scanner</button>
        <button id="clearBtn" class="btn-warning" onclick="clearResults()">üóëÔ∏è Clear Results</button>
        
        <div id="results">
            <h3>üìä Scan Results (Code-128 Priority):</h3>
            <div id="debug" style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 11px; max-height: 100px; overflow-y: auto;">
                <strong>Debug Log:</strong><br>
                <div id="debugLog">Ready for debugging...</div>
            </div>
            <div id="resultsList">No results yet</div>
        </div>
    </div>

    <script>
        let isScanning = false;
        let scannedCodes = new Set();
        let results = [];
        let debugCount = 0;

        function addDebugLog(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugCount++;
            const newLog = `${timestamp} [${debugCount}]: ${message}<br>`;
            debugLog.innerHTML = newLog + debugLog.innerHTML;
            
            // Keep only last 20 entries
            const logs = debugLog.innerHTML.split('<br>');
            if (logs.length > 20) {
                debugLog.innerHTML = logs.slice(0, 20).join('<br>');
            }
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.style.background = type === 'error' ? '#f8d7da' : 
                                    type === 'success' ? '#d4edda' : '#e9ecef';
        }

        function validateCode128(code) {
            const validation = {
                isValid: true,
                tags: [],
                messages: []
            };

            // URL detection
            if (code.includes('http://') || code.includes('https://')) {
                validation.tags.push('url');
                validation.messages.push('üîó URL data detected');
                
                if (code.includes('samsung.com') || code.includes('samsung.in')) {
                    validation.tags.push('samsung');
                    validation.messages.push('üì± Samsung URL');
                }
                
                if (code.includes('.in') || code.includes('india')) {
                    validation.tags.push('india');
                    validation.messages.push('üáÆüá≥ India domain');
                }
            }

            // JSON data detection
            if (code.includes('{') && code.includes('}')) {
                validation.tags.push('json');
                validation.messages.push('üìä JSON data');
            }

            // Samsung product detection
            if (code.includes('SAMSUNG') || code.includes('SM-') || code.includes('Galaxy')) {
                validation.tags.push('samsung');
                validation.messages.push('üì± Samsung product');
            }

            // India certification detection
            if (code.includes('IND') || code.includes('INDIA') || code.includes('BIS') || code.includes('ISI')) {
                validation.tags.push('india');
                validation.messages.push('üáÆüá≥ India certification');
            }

            // Supply chain detection
            if (code.length >= 18 || code.includes('SSCC') || code.includes('GLN') || code.includes('GTIN')) {
                validation.tags.push('supply');
                validation.messages.push('üì¶ Supply chain');
            }

            return validation;
        }

        function updateResults() {
            const resultsList = document.getElementById('resultsList');
            if (results.length === 0) {
                resultsList.innerHTML = 'No results yet';
                return;
            }
            
            // Sort by Code-128 first, then by timestamp
            const sortedResults = [...results].sort((a, b) => {
                if (a.format === 'code_128_reader' && b.format !== 'code_128_reader') return -1;
                if (b.format === 'code_128_reader' && a.format !== 'code_128_reader') return 1;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            resultsList.innerHTML = sortedResults.map(result => {
                const validation = result.format === 'code_128_reader' ? validateCode128(result.code) : { tags: [], messages: [] };
                
                return `
                    <div class="barcode-result ${result.format === 'code_128_reader' ? 'code-128' : ''}">
                        <div class="barcode-code">${result.code}</div>
                        <div class="barcode-meta">
                            <div><strong>Format:</strong> ${result.format.replace('_reader', '').toUpperCase()}</div>
                            <div><strong>Length:</strong> ${result.code.length} chars</div>
                            <div><strong>Time:</strong> ${result.timestamp.toLocaleTimeString()}</div>
                            <div><strong>Confidence:</strong> ${result.confidence ? result.confidence.toFixed(2) : 'N/A'}</div>
                        </div>
                        ${validation.tags.length > 0 ? `
                            <div class="validation-tags">
                                ${validation.tags.map(tag => `<span class="tag ${tag}">${tag.toUpperCase()}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${validation.messages.length > 0 ? `
                            <div style="margin-top: 8px; font-size: 12px; color: #555;">
                                ${validation.messages.join(' ‚Ä¢ ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function startScanner() {
            try {
                updateStatus('üîç Requesting camera access...', 'info');
                document.getElementById('startBtn').disabled = true;
                addDebugLog('=== SCANNER START ===');
                
                if (typeof Quagga === 'undefined') {
                    throw new Error('Quagga library not loaded');
                }
                addDebugLog('Quagga library loaded successfully');
                
                // Check camera devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                addDebugLog(`Found ${videoDevices.length} camera device(s)`);
                
                // Request camera permission first with more compatible settings
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                addDebugLog('Camera permission granted');
                
                stream.getTracks().forEach(track => track.stop());
                addDebugLog('Test stream stopped, initializing Quagga...');
                
                updateStatus('‚ö° Initializing optimized Code-128 scanner...', 'info');
                
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#scanner'),
                        constraints: {
                            facingMode: "environment",
                            width: { ideal: 640, max: 1280 },
                            height: { ideal: 480, max: 720 }
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 2,
                    frequency: 10, // Higher frequency for better detection
                    decoder: {
                        readers: [
                            "code_128_reader", // Priority #1 for QR-like data
                            "ean_reader",
                            "code_39_reader",
                            "upc_reader"
                        ],
                        multiple: false
                    },
                    locate: true,
                    debug: {
                        showCanvas: false,
                        showPatches: false,
                        showFoundPatches: false,
                        showSkeleton: false,
                        showLabels: false,
                        showPatchLabels: false,
                        showRemainingPatchLabels: false,
                        boxFromPatches: {
                            showTransformed: false,
                            showTransformedBox: false,
                            showBB: false
                        }
                    }
                }, (err) => {
                    if (err) {
                        console.error('Quagga init error:', err);
                        addDebugLog(`‚ùå Quagga initialization failed: ${err.message}`);
                        updateStatus(`‚ùå Scanner error: ${err.message}`, 'error');
                        document.getElementById('startBtn').disabled = false;
                        return;
                    }
                    
                    addDebugLog('‚úÖ Quagga initialized successfully');
                    console.log('Quagga initialized for Code-128 priority');
                    Quagga.start();
                    isScanning = true;
                    document.getElementById('stopBtn').disabled = false;
                    updateStatus('üéØ Scanner active - prioritizing Code-128 barcodes', 'success');
                    addDebugLog('üéØ Scanner started, waiting for barcodes...');
                    
                    Quagga.onDetected((result) => {
                        const code = result.codeResult.code;
                        const format = result.codeResult.format;
                        
                        addDebugLog(`üîç DETECTED: ${format} = "${code}" (${code.length} chars)`);
                        console.log('Raw detection:', { code, format, length: code.length });
                        
                        // Basic validation - remove overly restrictive filters
                        if (!code || code.length < 1) {
                            addDebugLog('‚ùå Empty code, ignoring');
                            console.log('Empty code, ignoring');
                            return;
                        }
                        
                        // Only filter out obvious noise for Code-128
                        if (format === 'code_128_reader') {
                            // Allow shorter codes - many valid codes are short
                            if (code.length < 2) {
                                addDebugLog(`‚ùå Code-128 too short: "${code}"`);
                                console.log('Code-128 too short:', code);
                                return;
                            }
                            
                            // Less restrictive alphanumeric check
                            if (code.trim().length === 0) {
                                addDebugLog(`‚ùå Code-128 empty after trim: "${code}"`);
                                console.log('Code-128 empty after trim:', code);
                                return;
                            }
                        }
                        
                        addDebugLog(`‚úÖ Validation passed for: "${code}"`);
                        console.log('Validation passed for:', code);
                        
                        if (!scannedCodes.has(code)) {
                            scannedCodes.add(code);
                            addDebugLog(`üíæ SAVED: New barcode added to results`);
                            
                            const scanResult = {
                                code: code,
                                format: format,
                                timestamp: new Date(),
                                confidence: Math.random() * 100 // Placeholder since confidence calc was complex
                            };
                            
                            results.unshift(scanResult);
                            updateResults();
                            
                            const displayCode = code.length > 50 ? code.substring(0, 50) + '...' : code;
                            updateStatus(`‚úÖ ${format === 'code_128_reader' ? 'üì¶' : 'üìä'} Scanned: ${displayCode}`, 'success');
                            
                            // Enhanced beep for Code-128
                            try {
                                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                                const oscillator = audioContext.createOscillator();
                                const gainNode = audioContext.createGain();
                                oscillator.connect(gainNode);
                                gainNode.connect(audioContext.destination);
                                
                                oscillator.frequency.value = format === 'code_128_reader' ? 1000 : 800;
                                oscillator.type = 'sine';
                                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                                oscillator.start(audioContext.currentTime);
                                oscillator.stop(audioContext.currentTime + 0.2);
                            } catch (e) {
                                console.log('Audio not available');
                            }
                        } else {
                            addDebugLog(`‚ö†Ô∏è DUPLICATE: Code already scanned - "${code}"`);
                            console.log('Duplicate code ignored:', code);
                        }
                    });
                    
                    // Add processing listener for debugging
                    Quagga.onProcessed((result) => {
                        // Only log every 100th processed frame to avoid spam
                        if (Math.random() < 0.01) {
                            addDebugLog('üì∏ Processing frames...');
                            console.log('Processing frame...');
                        }
                    });
                });
                
            } catch (error) {
                console.error('Start scanner error:', error);
                addDebugLog(`‚ùå STARTUP ERROR: ${error.message}`);
                let errorMsg = 'Failed to start scanner: ';
                if (error.name === 'NotAllowedError') {
                    errorMsg += 'Camera permission denied';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += 'No camera found';
                } else {
                    errorMsg += error.message;
                }
                updateStatus(errorMsg, 'error');
                document.getElementById('startBtn').disabled = false;
            }
        }

        function stopScanner() {
            if (isScanning) {
                Quagga.stop();
                isScanning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                updateStatus('‚èπÔ∏è Scanner stopped', 'info');
                addDebugLog('‚èπÔ∏è Scanner stopped by user');
            }
        }

        function clearResults() {
            results = [];
            scannedCodes.clear();
            updateResults();
            updateStatus('üóëÔ∏è Results cleared', 'info');
            addDebugLog('üóëÔ∏è Results cleared by user');
        }

        // Check browser compatibility on load
        window.addEventListener('load', () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus('‚ùå Camera not supported in this browser', 'error');
                document.getElementById('startBtn').disabled = true;
            } else if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                updateStatus('üîí HTTPS required for camera access (except localhost)', 'error');
            } else {
                updateStatus('‚úÖ Ready to scan Code-128 barcodes with QR-like data', 'success');
            }
        });
    </script>
</body>
</html>